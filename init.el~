;;; ==========================================================
;;; 0) Bootstrap / Early Init
;;; ==========================================================

;; When byte-compiling or loading from a file, set user-emacs-directory here.
(eval-and-compile
  (when (or load-file-name byte-compile-current-file)
    (setq user-emacs-directory
          (expand-file-name
           (file-name-directory (or load-file-name byte-compile-current-file))))))


;; Package archives & Leaf bootstrap
(eval-and-compile
  (customize-set-variable
   'package-archives '(("gnu"   . "https://elpa.gnu.org/packages/")
                       ("melpa" . "https://melpa.org/packages/")))
  (package-initialize)
  (unless (package-installed-p 'leaf)
    (package-refresh-contents)
    (package-install 'leaf))

  (leaf leaf-keywords
    :ensure t
    :init
    (leaf hydra :ensure t)
    (leaf blackout :ensure t)
    :config
    (leaf-keywords-init)))



;; Keep Customize output separate (and load it if exists)
(leaf cus-edit
  :doc "tools for customizing Emacs and Lisp packages"
  :tag "builtin" "faces" "help"
  :custom `((custom-file . ,(locate-user-emacs-file "custom.el")))
  :config
  (unless (file-exists-p custom-file)
    (with-temp-buffer (write-file custom-file)))
  (load custom-file 'noerror))


;; Startup behavior (suppress splash & prevent resizing flicker)
(setq inhibit-startup-screen t
      frame-inhibit-implied-resize t)


;; always use python tree-sitter
(add-to-list 'major-mode-remap-alist '(python-mode . python-ts-mode))
	     


;;; ==========================================================
;;; 2) Convenience Functions / Keybinds
;;; ==========================================================

;; Make C-h delete backward (instead of help)
(global-set-key (kbd "C-h") #'delete-backward-char)



;;; =========================================================
;;; file viewing functions
;;; =========================================================

(leaf pdf-tools
  :ensure t
  :config
  (pdf-tools-install))

(add-hook 'pdf-view-mode-hook
	  (lambda ()
	    (display-line-numbers-mode -1)))

(leaf treemacs
  :ensure t)


;;; =========================================================
;;; 3) Packages — Development Aids
;;; ---------------------------------------------------------
;;; Enhances editing, navigation, completion UI and LSP support
;;; =========================================================

;; Macro expansion helper
(leaf macrostep
  :ensure t)


(leaf undo-tree
  :ensure t
  :global-minor-mode global-undo-tree-mode
  :custom
  (undo-tree-auto-save-history . nil))

;; Vertico: minibuffer completion UI
;; - Replaces the default *Completion* window with a vertical list
;;   shown directly in the minibuffer.
;; - Affects all minibuffer-based commands
;;   (M-x, find-file, switch-to-buffer, etc.)
;; - Only changes how candidates are displayed;
;;   it does not change the matching algorithm itself.
(leaf vertico
  :ensure t
  :init (vertico-mode 1))


;; Completion style: flexible matching
;; Orderless enables space-separated pattern matching
;; Partial completion for file paths only
(leaf orderless
  :ensure t
  :init
  (setq completion-styles'(orderless)
	completion-category-defaults nil
	completion-category-overrides
	'((file (styles . (partial-completion))))))


;; Adds annotations to minibuffer completion candidates
;; (e.g., file type, variable/function info)
(leaf marginalia
  :ensure t
  :init (marginalia-mode 1))


;; Popup completion UI (CAPF front-end)
;; Integrates seamlessly with Eglot, Cape, dabbrev, etc.
;; Keys: C-n / C-p navigate, TAB to confirm
(leaf corfu
  :ensure t
  :custom ((corfu-auto . t)
	   (corfu-auto-prefix . 1)
	   (corfu-auto-delay . 0.02)
	   (corfu-quit-no-match . t)
	   (corfu-preselect . 'prompt))
  :bind (:corfu-map
         ("C-n" . corfu-next)
	 ("C-p" . corfu-previous)
         ("M-n" . corfu-next)
         ("M-p" . corfu-previous))
  :init
  (global-corfu-mode 1))


;; Show documentation and signature for completion candidates
(leaf corfu-popupinfo
  :after corfu
  :hook (corfu-mode . corfu-popupinfo-mode))


;; Built-in LSP client
;; Automatically starts LSP servers for supported languages
;; Examples: M-. go to definition, M-, go back, eglot-rename
(leaf eglot
  :tag "builtin"
  :hook ((python-mode        . eglot-ensure)
	 (python-ts-mode     . eglot-ensure)
	 (typescript-ts-mode . eglot-ensure)
	 (tsx-ts-mode        . eglot-ensure)
	 (js-ts-mode         . eglot-ensure))
  :custom
  (eglot-autoshutdown . t)
  :config
  (add-to-list 'eglot-server-programs
	   '((js-ts-mode typescript-ts-mode tsx-ts-mode)
	     . ("typescript-language-server" "--stdio"))))



(require 'web-mode)

;; Astro Mode ----------------------------------------------------
;; (setup for using Astro based on web-mode)
(define-derived-mode astro-mode web-mode "Astro"
  "Major mode for Astro (.astro)files.")

;; link astro-mode to .astro
(add-to-list 'auto-mode-alist '("\\.astro\\'" . astro-mode))

(add-to-list 'web-mode-content-types-alist
             '("jsx" . "\\.astro\\'"))

;; assosiation of Eglot(LSP) and Atsto
(with-eval-after-load 'eglot
  (add-to-list 'eglot-server-programs
               '(astro-mode .
                            ("astro-ls" "--stdio"
                             :initializationOptions
                             (:typescript
                              (:tsdk "node_modules/typescript/lib"))))))

;; activate Eglot Automatically when I use Astro
(add-hook 'astro-mode-hook #'eglot-ensure)

(leaf web-mode
  :ensure t
  :mode ("\\.html\\'" "\\.css\\'")
  :config
  (setq web-mode-markup-indent-offset 2
        web-mode-css-indent-offset 2
        web-mode-code-indent-offset 2
        web-mode-enable-auto-indentation nil
        indent-tabs-mode nil)

  ;; --- Astro 専用設定（ここが今回の追加部分ですの） ---
  (add-to-list 'web-mode-engines-alist '("astro" . "\\.astro\\'"))
  (setq web-mode-engine-detection t)
)




;; Enable Tree-sitter based TypeScript mode
(leaf typescript-ts-mode
  :ensure nil ;; built-in
  :config
  (add-to-list 'auto-mode-alist '("\\.ts\\'"  . typescript-ts-mode)))
(leaf tsx-ts-mode
  :ensure nil ;; built-in
  :config
  (add-to-list 'auto-mode-alist '("\\.tsx\\'" . tsx-ts-mode)))



(with-eval-after-load 'web-mode
  ;; インデント幅をすべて2に統一（HTML / CSS / JS / Astro など）
  (setq web-mode-markup-indent-offset 2)
  (setq web-mode-css-indent-offset 2)
  (setq web-mode-code-indent-offset 2)

  ;; タブではなくスペースで
  (setq indent-tabs-mode nil)

  ;; 自動インデントの暴走を抑える
  (setq web-mode-enable-auto-indentation nil)
)


(leaf sqlite
  :require t)

;; open DB
(setq db (sqlite-open "~/iniad/cs2_lec_handout/blog_sample/db.sqlite3"))

;; table list
(sqlite-execute db "SELECT name FROM sqlite_master WHERE type='table';")

;; get data
(sqlite-select db "SELECT * FROM blog_article;")



;; Extra completion sources to supplement LSP
;; - dabbrev: buffer-based word completion
;; - file: file path completion
(leaf cape
  :ensure t
  :require t
  :config
  (defun my/eglot-super-capf ()
    "Use Eglot CAPF only in managed buffers."
    (setq-local
     completion-at-point-functions
     (if (bound-and-true-p eglot--managed-mode)
         '(eglot-completion-at-point
           cape-file
           cape-dabbrev)
       '(cape-file
         cape-dabbrev))))
  (add-hook 'prog-mode-hook #'my/eglot-super-capf))



(leaf vterm
  :ensure t)



(leaf magit
  :ensure t
  :commands (magit-status))



;;; =========================================================
;;; 4) Jupyter Integration
;;; =========================================================

(leaf jupyter
  :ensure t
  :after org
  :config
  (setenv "PATH"
	  (concat "/home/trt-ryzen7/anaconda3/bin:"
		  (getenv "PATH")))
  (add-to-list 'exec-path
	       "/home/trt-ryzen7/anaconda3/bin")
  (setq jupyter-command
	"/home/trt-ryzen7/anaconda3/bin/jupyter")
  
  ;; add jupyter to Org babel
  (add-to-list
   'org-babel-load-languages '(jupyter . t))
  (org-babel-do-load-languages
   'org-babel-load-languages org-babel-load-languages)

  (add-hook 'org-mode-hook
	    (lambda ()
	      (setq-local completion-at-point-functions
			  (remq #'jupyter-org-completion-at-point
				completion-at-point-functions))
	      (setq-local corfu-auto-delay 0.15)))
  
  ;; allow Jupyter CAPF when it is in Org Sorce blok
  (with-eval-after-load 'jupyter-org
    (ignore-errors
      (advice-remove 'jupyter-org-completion-at-point
		     #'my/jupyter-capf-guard)))
  
  ;; fix python command to Anaconda one
  (setq org-babel-python-command
	"/home/trt-ryzen7/anaconda3/bin/python")

  ;; stop asking the confirmation when evaluate code block
  (setq org-confirm-babel-evaluate nil))

(with-eval-after-load 'jupyter-org
  (ignore-errors
    (advice-remove 'jupyter-org-completion-at-point
		   #'my/jupyter-capf-guard))
  (defun my/jupyter-capf-null (&rest _args) nil)
  (advice-add 'jupyter-org-completion-at-point
	      :override #'my/jupyter-capf-null))



;;; =========================================================
;;; Github Copilot (copilot.el)
;;; =========================================================

(leaf copilot
  :ensure t
  :hook prog-mode-hook
  :bind
  (:copilot-completion-map
   ("<tab>" . copilot-accept-completion)
   ("M-n"   . copilot-next-completion)
   ("M-p"   . copilot-previous-completion)))

;;; =========================================================
;;; 6) Common Lisp (SLY + SBCL)
;;; =========================================================

(leaf sly
  :ensure t
  :hook
  (lisp-mode-hook . sly-mode)
  :custom
  (inferior-lisp-program . "sbcl"))



;;; ========================================================
;;; 6.5) JOKE
;;; ========================================================

(leaf podcaster
  :ensure t
  :custom
  ((podcaster-mp3-player . "mpv")
   (podcaster-mp3-player-extra-params
    . '("--no-video" "--really-quiet" "--force-window=no" "--idle=no"))))

(leaf vim-jp-radio
  :vc ( :url "https://github.com/vim-jp-radio/vim-jp-radio.el"))



(leaf w3m
  :ensure t
  :commands (w3m w3m-browse-url)
  :config
  (setq w3m-display-inline-images t)
  (setq browse-url-browser-function 'w3m-browse-url))


;;; =========================================================
;;; 7) Optional Themes Package (kept if you use doom-themes elsewhere)
;;; =========================================================


;; Kept disabled (no direct dependency for transparency); enable if you use it.
;; (leaf doom-themes :ensure t)



;;; ========================================================
;;; 8) org-mode
;;; ========================================================

(leaf org
  :hook
  ((org-mode-hook . visual-line-mode))
  :custom
  (org-src-fontify-natively         . t)
  (org-src-tab-acts-natively        . t)
  (org-edit-src-content-indentation . 0)
  (org-src-preserve-indentation     . t)
  (org-src-window-setup             . 'split-window-below)
  :config
  (setq org-todo-keywords
	'((sequence "TODO(t)" "DOING(o)" "|" "DONE(d)" "CANCEL(c)")))
  (add-to-list 'org-src-lang-modes '("python" . python-ts)))
  
  ;; org-capture settings
  ;; Todo capture is now available
  (setq org-capture-templates
	'(("t" "Todo" entry
	   (file+headline "~/org/inbox.org" "Tasks")
	   "* TODO %?\n  %U\n")))
  
  ;; display png file on current buffer automatically
  (add-hook 'org-babel-after-execute-hook
	    'org-display-inline-images)
  (setq org-startup-with-inline-images t)

;; make UI modern 
(leaf org-modern
  :ensure t
  :hook (org-mode-hook . org-modern-mode)
  :custom
  (org-modern-hide-stars . t))



;; Personal Knowledge Management System
(leaf org-roam
  :ensure t
  :after org
  :preface
  ;; Org-roam prefix (C-c n)
  (define-prefix-command 'org-roam-prefix)
  :bind
  (("C-c n" . org-roam-prefix))
  :config
  (setq org-roam-directory (expand-file-name "~/org/roam/" org-directory))

  (define-key org-roam-prefix (kbd "f") #'org-roam-node-find)
  (define-key org-roam-prefix (kbd "i") #'org-roam-node-insert)
  (define-key org-roam-prefix (kbd "c") #'org-roam-capture)

  (define-prefix-command 'org-roam-dailies-prefix)
  (define-key org-roam-prefix (kbd "d") 'org-roam-dailies-prefix)
  (define-key org-roam-dailies-prefix (kbd "d") #'org-roam-dailies-goto-today)
  (define-key org-roam-dailies-prefix (kbd "t") #'org-roam-dailies-capture-today)

  (org-roam-db-autosync-mode 1))



;; Graphviz providing visualized graph structure
(leaf org-roam-graph
  :after org-roam
  :config
  (setq org-roam-graph-viewer nil
	org-roam-graph-executable "dot"
	org-roam-graph-filetype "svg"
	org-roam-graph-extra-config
	'(("overlap" . "false")
          ("splines" . "true")
          ("rankdir" . "LR")   
          ("nodesep" . "0.35")
          ("ranksep" . "0.6")
          ("dpi" . "150")))
  (setq org-roam-graph-node-extra-config
        '((shape . "box") (style . "rounded,filled")
          (fillcolor . "white") (color . "gray30")))
  (setq org-roam-graph-edge-extra-config
        '((color . "gray40") (penwidth . "1.1"))))



;;; =========================================================
;;; Reveal.js
;;; =========================================================

(leaf ox-reveal
  :ensure t
  :config
  (require 'ox-reveal))

(setq org-reveal-root "file:///home/trt-ryzen7/reveal.js")

;(setq org-reveal-highlight "zenburn")
;(setq org-src-fontify-natively t)
;(setq org-src-tab-acts-natively t)



;;; =========================================================
;;; Footer
;;; =========================================================

;;; =========================================================
;;; Load Custom Configs
;;; =========================================================
;;; In the future, make load setup like this
;;; (dolist (file '("ui" "mail"))
;;;   (load (expand-file-name (format "config/%s.el" file)
;;;                           user-emacs-directory)))
;;; ========================================================

(load (expand-file-name "config/ui.el" user-emacs-directory))
(load (expand-file-name "config/mail.el" user-emacs-directory))
(load (expand-file-name "config/elcord.el" user-emacs-directory))

(provide 'init)
;;; init.el ends here.
